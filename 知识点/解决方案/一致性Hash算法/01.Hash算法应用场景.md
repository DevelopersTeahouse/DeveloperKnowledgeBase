# Hash 算法应用场景

## Hash 算法在分布式集群架构中的应用场景

- Hash 算法在很多分布式集群产品中都有应用，比如分布式集群架构 Redis、Hadoop、ElasticSearch、MySQL 分库分表、Nginx 负载均衡等

## 主要的应用场景归纳起来就两个

### 请求的负载均衡（比如 Nginx 的中的 ip_hash 策略）

- Nginx 的 ip_hash 策略可以在客户端 ip 不变的情况下，将其发出的请求始终路由到同一个目标服务器上，实现会话粘滞，避免处理 session 共享问题
- 如果没有 ip_hash ，可以维护一张映射表，用来存储客户端 IP 或者 sessionId 与具体目标服务器的映射关系
  - 但是，如果客户端很多的时候，映射表非常大，浪费内存空间
  - 客户端上下线，目标服务器上下线，都会导致需要重新维护映射表，映射表维护成本很大
- 如果使用 hash 算法，我们就可以丢 ip 地址或者 sessionId 进行计算哈希值，哈希值与服务器数量进行取模运算，得到的值就是当前请求应该被路由到的服务器编号，如此，同一个客户端 ip 发送过来的请求就可以路由到同一个目标服务器，实现会话粘滞

### 分布式存储

- 以分布式内存数据库 Redis 为例，集群中有 redis1，redis2，redis3 三台 Redis 服务器。在进行数据存储时，<key1, value1> 数据存储到哪个服务器中，可以针对 key 进行 hash 处理 hash (key1) % 3 = index，使用余数 index 锁定存储的具体服务器节点

## 普通 Hash 算法存在的问题

- 普通 Hash 算法存在⼀个问题，以 ip_hash 为例，假定下载⽤户 ip 固定没有发⽣改变，现在某个 tomcat 出现了问题，down 机了，服务器数量发生了变动，之前所有的求模都需要重新计算。
- 如果在真实⽣产情况下，后台服务器很多台，客户端也有很多，那么影响是很⼤的，缩容和扩容都会存在这样的问题，⼤量⽤户的请求会被路由到其他的⽬标服务器处理，⽤户在原来服务器中的会话都会丢失。
