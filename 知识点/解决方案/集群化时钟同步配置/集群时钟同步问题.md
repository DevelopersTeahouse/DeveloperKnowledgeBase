# 集群时钟同步问题

## 服务器时间不同步导致的问题

- 如果集群中的各个服务器时钟不一致势必会导致一系列的问题
  
  - 比如说电商网站业务，新增一条订单，势必会在订单表中增加一条记录，那条记录中应该会有下单时间类似的字段。如果我们的系统是集群化部署的，或者数据库时分库分表的集群化部署的，然后系统的时钟不一致，我们的数据就会混乱

## 集群时钟同步思路

### 分布式集群中各个服务器节点都可以连接互联网

```shell
# 使用ntpdate网络时间同步命令
ntpdate -u ntp.api.bz
```

- 可以使用 Linux 的定时任务，每隔一段时间执行一次 ntpdate 命令

### 分布式集群中某一个服务器节点可以访问互联网或者所有节点都不能访问互联网

- 选取集群中的一个服务器节点 A 作为时间服务器（整个集群时间从这台服务器同步，如果这台服务器能够访问互联网，可以让这台服务器和网络时间保持同步，如果不能就手动设置一个时间）
  - 首先设置好服务器 A 的时间
  - 把 A 配置成时间服务器 (修改/etc/ntp.conf 文件)
    - 如果有 `restrict default ignore`，就需要注释掉
    - 添加如下配置
      - `restrict *.*.0.0 mask 255.255.255.0 nomodify notrap` 这是开放局域网同步通能， `*.*.0.0` 就是时间服务器的局域网段
      - `server 127.127.1.0`
      - `fudge 127.127.1.0 stratum 10`
    - 重启生效并配置 ntpd 服务开机自启动
      - `service ntpd restart`
      - `chkconfig ntpd on`
  - 集群中其他节点可以从 A 服务器同步时间
    - `ntpdate *.*.*.*` 指定时间服务器 ip 就行了
